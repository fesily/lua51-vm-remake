-- test the cacheable dictionary case

function addProps1(t, k)
	for i=1,5 do
		t["a" .. i ] = i * k
	end
	return t
end

function addProps2(t, k)
	for i=6,10 do
		t["a" .. i ] = i * k
	end
	return t
end

function get_impl(t, i)
	return t[i]
end

function get0(t)
	return get_impl(t, 0)
end

function get1(t)
	return get_impl(t, 1)
end

function get2(t)
	return get_impl(t, 2)
end

function get3(t)
	return get_impl(t, 'a3')
end

function get4(t)
	return get_impl(t, 'a8')
end

print('-- test 1 --')
t1 = addProps1({}, 1)
t2 = addProps1({}, 2)
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t1[1] = 123
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t2[1] = 'a'
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t1[0] = 'b'
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t2[0] = 'p'
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

mt = {
	__index = function(base, idx)
		print('in metatable (test 1), idx = ', idx)
		return 2333
	end
}

setmetatable(t1, mt)

print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

setmetatable(t2, mt)

print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t1[0] = nil
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t2[0] = nil
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t1[1] = 123
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t1['a3'] = 888
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t2['a3'] = 456
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t1 = addProps2(t1, 1)
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t2 = addProps2(t2, 2)
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t1[0] = 'c'
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

t2[1] = 'd'
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

setmetatable(t1, {})
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

setmetatable(t2, {})
print(get0(t1))
print(get0(t1))
print(get0(t2))
print(get0(t2))
print(get1(t1))
print(get1(t1))
print(get1(t2))
print(get1(t2))
print(get2(t1))
print(get2(t1))
print(get2(t2))
print(get2(t2))
print(get3(t1))
print(get3(t1))
print(get3(t2))
print(get3(t2))
print(get4(t1))
print(get4(t1))
print(get4(t2))
print(get4(t2))

